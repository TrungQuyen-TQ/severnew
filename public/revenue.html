<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Qu·∫£n l√Ω doanh thu nh√† h√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-white font-sans">
  <div class="flex h-screen">

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">üìà Dashboard Doanh thu</h1>
        <div class="flex items-center space-x-4">
          <input type="month" id="monthPicker" value="2025-11"
            class="px-3 py-2 rounded bg-gray-800 text-white border border-gray-600">
          <button id="loadBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">
            T·∫£i d·ªØ li·ªáu
          </button>
        </div>
      </header>

      <!-- Th·ªëng k√™ t·ªïng -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg">
          <div class="text-gray-400">T·ªïng doanh thu</div>
          <div id="totalRevenue" class="text-3xl font-bold text-blue-400">0 VNƒê</div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg">
          <div class="text-gray-400">S·ªë ƒë∆°n h√†ng</div>
          <div id="totalOrders" class="text-3xl font-bold text-green-400">0</div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg">
          <div class="text-gray-400">Ng√†y cao nh·∫•t</div>
          <div id="bestDay" class="text-2xl font-semibold text-orange-400">--</div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg">
          <div class="text-gray-400">TƒÉng tr∆∞·ªüng</div>
          <div id="growth" class="text-2xl font-semibold text-purple-400">--%</div>
        </div>
      </section>

      <!-- Bi·ªÉu ƒë·ªì doanh thu -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h2 class="text-xl font-semibold mb-4">Bi·ªÉu ƒë·ªì doanh thu theo ng√†y (Line)</h2>
          <div class="relative h-64"> <!-- TH√äM ƒêO·∫†N N√ÄY -->
            <canvas id="lineChart"></canvas> <!-- X√ìA height="120" ·ªü ƒë√¢y -->
          </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì doanh thu theo ng√†y (C·ªôt) -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h2 class="text-xl font-semibold mb-4">Bi·ªÉu ƒë·ªì doanh thu theo ng√†y (C·ªôt)</h2>
          <div class="relative h-64"> <!-- TH√äM ƒêO·∫†N N√ÄY -->
            <canvas id="barChart"></canvas> <!-- X√ìA height="120" ·ªü ƒë√¢y -->
          </div>
        </div>
      </section>

      <!-- Bi·ªÉu ƒë·ªì tr√≤n -->
      <section class="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">T·ª∑ l·ªá doanh thu theo danh m·ª•c m√≥n ƒÉn</h2>
        <div class="relative h-80 w-full md:w-1/2 mx-auto">
          <!-- TH√äM ƒêO·∫†N N√ÄY, c√≥ th·ªÉ th√™m w-1/2 v√† mx-auto ƒë·ªÉ cƒÉn gi·ªØa v√† gi·ªõi h·∫°n chi·ªÅu r·ªông cho bi·ªÉu ƒë·ªì tr√≤n -->
          <canvas id="pieChart"></canvas> <!-- X√ìA height="120" ·ªü ƒë√¢y -->
        </div>
      </section>

      <!-- Top m√≥n b√°n ch·∫°y -->
      <section class="bg-gray-800 rounded-xl p-6 mb-8 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Top m√≥n b√°n ch·∫°y nh·∫•t</h2>
        <div id="topProducts" class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
      </section>

      <!-- B·∫£ng chi ti·∫øt doanh thu -->
      <section class="bg-gray-800 rounded-xl p-6 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Chi ti·∫øt doanh thu theo ng√†y</h2>
        <table class="w-full text-center border border-gray-700">
          <thead class="bg-gray-700">
            <tr>
              <th class="p-2 border border-gray-700">Ng√†y</th>
              <th class="p-2 border border-gray-700">Doanh thu (VNƒê)</th>
            </tr>
          </thead>
          <tbody id="revenueTable"></tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    // H√†m ch√≠nh ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã d·ªØ li·ªáu doanh thu
    async function loadRevenue() {
      const [year, month] = document.getElementById("monthPicker").value.split("-");

      // === 1. Reset t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ hi·ªÉn th·ªã d·ªØ li·ªáu V·ªÄ TR·∫†NG TH√ÅI M·∫∂C ƒê·ªäNH ===
      document.getElementById("totalRevenue").innerText = "0 VNƒê";
      document.getElementById("totalOrders").innerText = "0";
      document.getElementById("bestDay").innerText = "--";
      document.getElementById("growth").innerText = "--%";
      document.getElementById("revenueTable").innerHTML = ""; // X√≥a n·ªôi dung b·∫£ng
      document.getElementById("topProducts").innerHTML = `
      <div class="col-span-full text-center text-gray-400">ƒêang t·∫£i Top s·∫£n ph·∫©m...</div>
    `; // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i cho top s·∫£n ph·∫©m

      // === 2. H·ªßy c√°c bi·ªÉu ƒë·ªì hi·ªán c√≥ ƒë·ªÉ tr√°nh l·ªói v√† s·∫µn s√†ng v·∫Ω l·∫°i ===
      // Ki·ªÉm tra n·∫øu n√≥ l√† m·ªôt instance c·ªßa Chart tr∆∞·ªõc khi destroy
      if (window.lineChart instanceof Chart) {
        window.lineChart.destroy();
        window.lineChart = null;
      }
      if (window.barChart instanceof Chart) {
        window.barChart.destroy();
        window.barChart = null;
      }
      if (window.pieChart instanceof Chart) {
        window.pieChart.destroy();
        window.pieChart = null;
      }

      // === 3. G·ªçi API l·∫•y d·ªØ li·ªáu doanh thu h√†ng ng√†y ===
      const res = await fetch(`/api/revenue?month=${month}&year=${year}`);
      const data = await res.json();
      const rows = data.daily_details || [];

      // === 4. X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng c√≥ d·ªØ li·ªáu ===
      if (rows.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu cho th√°ng n√†y!");
        renderEmptyCharts(); // H√†m n√†y s·∫Ω t·∫°o c√°c bi·ªÉu ƒë·ªì r·ªóng ho·∫∑c v·ªõi th√¥ng b√°o
        document.getElementById("topProducts").innerHTML = `
        <div class="col-span-full text-center text-gray-400">Kh√¥ng c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m b√°n ch·∫°y.</div>
      `;
        // Ch·ªâ g·ªçi loadCategoryRevenue n·∫øu mu·ªën hi·ªÉn th·ªã bi·ªÉu ƒë·ªì r·ªóng cho category
        // N·∫øu kh√¥ng, bi·ªÉu ƒë·ªì pie c≈©ng s·∫Ω b·ªã tr·ªëng b·ªüi renderEmptyCharts
        loadCategoryRevenue(); // V·∫´n g·ªçi ƒë·ªÉ x·ª≠ l√Ω ri√™ng tr∆∞·ªùng h·ª£p category kh√¥ng c√≥ d·ªØ li·ªáu
        return; // D·ª´ng h√†m t·∫°i ƒë√¢y n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
      }

      // === 5. X·ª≠ l√Ω v√† hi·ªÉn th·ªã c√°c s·ªë li·ªáu th·ªëng k√™ t·ªïng h·ª£p ===
      const total = rows.reduce((sum, r) => sum + Number(r.revenue), 0);
      document.getElementById("totalRevenue").innerText = total.toLocaleString("vi-VN") + " VNƒê";
      document.getElementById("totalOrders").innerText = rows.length.toString(); // S·ªë ƒë∆°n h√†ng ch√≠nh l√† s·ªë ng√†y c√≥ doanh thu ·ªü ƒë√¢y

      // Ng√†y cao nh·∫•t
      const best = rows.reduce((max, r) => Number(r.revenue) > Number(max.revenue) ? r : max, rows[0]);
      document.getElementById("bestDay").innerText = best.date;

      // TƒÉng tr∆∞·ªüng (c·∫ßn ki·ªÉm tra ƒë·ªÉ tr√°nh chia cho 0 n·∫øu ch·ªâ c√≥ 1 ng√†y ho·∫∑c doanh thu ng√†y ƒë·∫ßu b·∫±ng 0)
      let growth = "--%";
      if (rows.length > 1 && Number(rows[0].revenue) !== 0) {
        growth = (((Number(best.revenue) - Number(rows[0].revenue)) / Number(rows[0].revenue)) * 100).toFixed(1) + "%";
      } else if (rows.length === 1 && Number(rows[0].revenue) > 0) {
        growth = "N/A (Ch·ªâ c√≥ 1 ng√†y)";
      }
      document.getElementById("growth").innerText = growth;

      // === 6. ƒêi·ªÅn d·ªØ li·ªáu v√†o b·∫£ng chi ti·∫øt doanh thu ===
      const tbody = document.getElementById("revenueTable");
      tbody.innerHTML = rows.map(r => `
      <tr>
        <td class="border border-gray-700 py-2">${r.date}</td>
        <td class="border border-gray-700 py-2">${Number(r.revenue).toLocaleString("vi-VN")} VNƒê</td>
      </tr>
    `).join("");

      // === 7. Render c√°c bi·ªÉu ƒë·ªì v√† t·∫£i d·ªØ li·ªáu b·ªï sung ===
      renderCharts(rows); // V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng v√† c·ªôt v·ªõi d·ªØ li·ªáu m·ªõi
      loadTopProducts(); // T·∫£i v√† hi·ªÉn th·ªã top s·∫£n ph·∫©m b√°n ch·∫°y
      loadCategoryRevenue(); // T·∫£i v√† hi·ªÉn th·ªã doanh thu theo danh m·ª•c
    }

    // H√†m ƒë·ªÉ v·∫Ω c√°c bi·ªÉu ƒë·ªì ch√≠nh (Line v√† Bar)
    function renderCharts(rows) {
      const labels = rows.map(r => r.date);
      const values = rows.map(r => Number(r.revenue));

      // Line chart
      const ctx1 = document.getElementById("lineChart").getContext("2d");
      if (window.lineChart instanceof Chart) window.lineChart.destroy();
      window.lineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Doanh thu (VNƒê)",
            data: values,
            borderColor: "#60a5fa",
            backgroundColor: "rgba(59,130,246,0.3)",
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value, index, values) {
                  return value.toLocaleString("vi-VN"); // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
                }
              }
            }
          },
          plugins: {
            title: {
              display: false // ·∫®n ti√™u ƒë·ªÅ n·∫øu c√≥ d·ªØ li·ªáu
            }
          }
        }
      });

      // Bar chart
      const ctx2 = document.getElementById("barChart").getContext("2d");
      if (window.barChart instanceof Chart) window.barChart.destroy();
      window.barChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Doanh thu (VNƒê)",
            data: values,
            backgroundColor: "#34d399"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value, index, values) {
                  return value.toLocaleString("vi-VN"); // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
                }
              }
            },
            x: { // Th√™m t√πy ch·ªçn cho tr·ª•c x
              barPercentage: 0.5, // C·ªôt s·∫Ω chi·∫øm 50% kh√¥ng gian ƒë∆∞·ª£c ph√¢n b·ªï cho n√≥
              categoryPercentage: 0.7 // C√°c danh m·ª•c s·∫Ω chi·∫øm 70% kh√¥ng gian tr·ª•c x
            }
          },

          plugins: {
            title: {
              display: false // ·∫®n ti√™u ƒë·ªÅ n·∫øu c√≥ d·ªØ li·ªáu
            }
          }
        }
      });
    }

    // H√†m m·ªõi ƒë·ªÉ render bi·ªÉu ƒë·ªì tr·ªëng ho·∫∑c v·ªõi th√¥ng b√°o khi kh√¥ng c√≥ d·ªØ li·ªáu
    function renderEmptyCharts() {
      const defaultChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              display: false // ·∫®n ticks tr·ª•c y
            }
          },
          x: {
            ticks: {
              display: false // ·∫®n ticks tr·ª•c x
            }
          }
        },
        plugins: {
          tooltip: {
            enabled: false
          },
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu',
            color: '#aaa',
            font: {
              size: 16
            }
          }
        }
      };

      const ctx1 = document.getElementById("lineChart").getContext("2d");
      if (window.lineChart instanceof Chart) window.lineChart.destroy();
      window.lineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: [],
          datasets: []
        },
        options: defaultChartOptions
      });

      const ctx2 = document.getElementById("barChart").getContext("2d");
      if (window.barChart instanceof Chart) window.barChart.destroy();
      window.barChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: [],
          datasets: []
        },
        options: defaultChartOptions
      });

      // Bi·ªÉu ƒë·ªì tr√≤n (Doughnut) c≈©ng c·∫ßn x·ª≠ l√Ω ri√™ng cho tr∆∞·ªùng h·ª£p tr·ªëng
      const ctx3 = document.getElementById("pieChart").getContext("2d");
      if (window.pieChart instanceof Chart) window.pieChart.destroy();
      window.pieChart = new Chart(ctx3, {
        type: "doughnut",
        data: {
          labels: [],
          datasets: []
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              enabled: false
            },
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c',
              color: '#aaa',
              font: {
                size: 16
              }
            }
          }
        }
      });
    }


    // H√†m ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã doanh thu theo danh m·ª•c
    async function loadCategoryRevenue() {
      const res = await fetch("/api/revenue/by-category");
      const data = await res.json();

      const ctx = document.getElementById("pieChart").getContext("2d");
      if (window.pieChart instanceof Chart) window.pieChart.destroy();

      if (data && data.length > 0) {
        window.pieChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: data.map(d => d.category),
            datasets: [{
              data: data.map(d => Number(d.total_revenue)),
              backgroundColor: ["#60a5fa", "#fbbf24", "#34d399", "#f87171", "#a78bfa", "#9ca3af", "#d1d5db"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: false // ·∫®n ti√™u ƒë·ªÅ n·∫øu c√≥ d·ªØ li·ªáu
              },
              legend: {
                position: 'right', // Hi·ªÉn th·ªã ch√∫ th√≠ch ·ªü b√™n ph·∫£i
                labels: {
                  color: '#ddd',
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.raw !== null) {
                      label += Number(context.raw).toLocaleString("vi-VN") + " VNƒê";
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      } else {
        // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c, hi·ªÉn th·ªã bi·ªÉu ƒë·ªì tr·ªëng v·ªõi th√¥ng b√°o
        const defaultChartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              enabled: false
            },
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c',
              color: '#aaa',
              font: {
                size: 16
              }
            }
          }
        };
        window.pieChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [],
            datasets: []
          },
          options: defaultChartOptions
        });
      }
    }

    // H√†m ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã top s·∫£n ph·∫©m b√°n ch·∫°y
    async function loadTopProducts() {
      const container = document.getElementById("topProducts");
      container.innerHTML = `<div class="col-span-full text-center text-gray-400">ƒêang t·∫£i...</div>`; // Th√™m tr·∫°ng th√°i loading


      try {
        const res = await fetch("/api/top-products");
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();

        if (data && data.length > 0) {
          container.innerHTML = data.map(item => `
          <div class="bg-gray-700 p-4 rounded-lg shadow">
            <img src="${item.image_url || 'https://via.placeholder.com/150'}" alt="${item.name}" class="rounded-lg w-full h-32 object-cover mb-2">
            <div class="font-semibold">${item.name}</div>
            <div class="text-sm text-gray-300">ƒê√£ b√°n: ${item.total_sold}</div>
          </div>
        `).join("");
        } else {
          container.innerHTML = `
          <div class="col-span-full text-center text-gray-400">Kh√¥ng c√≥ s·∫£n ph·∫©m b√°n ch·∫°y trong th√°ng n√†y.</div>
        `;
        }
      } catch (error) {
        console.error("L·ªói khi t·∫£i top s·∫£n ph·∫©m:", error);
        container.innerHTML = `
        <div class="col-span-full text-center text-red-400">L·ªói khi t·∫£i top s·∫£n ph·∫©m: ${error.message}</div>
      `;
      }
    }

    // === ƒêƒÇNG K√ù S·ª∞ KI·ªÜN ===

    // X·ª≠ l√Ω khi nh·∫•n n√∫t "T·∫£i d·ªØ li·ªáu"
    document.getElementById("loadBtn").addEventListener("click", loadRevenue);

    // X·ª≠ l√Ω khi trang ƒë∆∞·ª£c t·∫£i l·∫ßn ƒë·∫ßu
    window.addEventListener("load", () => {
      // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho th√°ng ch·ªçn l√† th√°ng v√† nƒÉm hi·ªán t·∫°i
      const today = new Date();
      const month = (today.getMonth() + 1).toString().padStart(2, '0'); // month l√† 0-indexed
      const year = today.getFullYear();
      document.getElementById("monthPicker").value = `${year}-${month}`;

      loadRevenue(); // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu khi trang ƒë∆∞·ª£c load
    });
  </script>
</body>

</html>